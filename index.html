<!DOCTYPE html>
<html lang="en">

<head>
  <title>Play Your Music (for Google Drive)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="Play music from Google Drive.">
  <link rel="manifest" href="/manifest.json">
  <link rel="shortcut icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" integrity="sha256-BtbhCIbtfeVWGsqxk1vOHEYXS6qcvQvLMZqjtpWUEx8=" crossorigin="anonymous" />
</head>

<body>

<header>
  <button id="menu-toggle">▲</button>
  <h1 class="visually-hidden"><a href="">▶ Play Your Music</a></h1>
  <nav id="menu">
    <h2>Authentication</h2>
    <button id="authorize_button" style="display: none;">Sign In</button>
    <button id="signout_button" style="display: none;">Sign Out</button>
  </nav>
</header>

<div id="albums"></div>
<div id="track-list"></div>
<button id="track-list-close">&times;</button>


<div class="audio-player">

  <a id="audio-player-current-link" href="">
    <img class="audio-player-album-image" src="" />
    <p class="audio-player-song-text">Now Playing...</p>
  </a>

  <div id="play-btn"></div>

  <audio id="player">
    <source src="" type="audio/mp3">
  </audio>

</div>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script type="text/javascript" src="auth.js"></script>
<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
<script type="text/javascript" src="api.js"></script>


<script type="text/javascript">

function playTrack(id) {

  var audio = $("audio");  
  $('source').attr("src", id);
  $('source').attr("data-track-id", id);
  audio[0].pause();
  audio[0].load(); //suspends and restores all audio element
  audio[0].oncanplaythrough = audio[0].play();

  $(".track[data-track-id='" + id + "']").addClass('track-active');
  $('.audio-player-song-text').html( $('.track[data-track-id="'+id+'"]').text() );
  $('#play-btn').html('<i class="fas fa-pause"></i>');

}

$( document ).ready(function() {

  window.onhashchange = function() {
    if (window.location.hash == "") {
      $('#track-list-close').click();
    }
  }

  $(document).on('click', '.track', function(e){
    $(".track-active").removeClass('track-active'); // reset track highlight
    playTrack( $(this).attr("data-track-id") );
    $('.audio-player').show();
    $('.audio-player-album-image').attr('src', $('.track-list-album-image').attr('src') );
  });

  $(document).on('click', '.album', function(e){

    window.location.hash = $(this).attr("data-album-name").split(' ').join('_');

    $('#track-list').html(`
      <img class='track-list-album-image' src=''/>
      <span class='track-list-album-name'></span>
      <span style='display: block; clear: both;'></span>
    `); // reset track list 
    listTracks( $(this).attr("data-album-id") );

    $('.track-list-album-name').html( $(this).attr("data-album-name") );
    $('.track-list-album-image').attr('src', $(this).children(":first").attr('src'))
    $('#track-list').css('min-height', $('#albums').height() );
    $('#track-list').show();

  });

  $(document).on('click', '#track-list-close', function(e){
    $('#track-list').hide();
    $('#track-list-close').hide();
    window.location.hash = "";
  });

  $(document).on('click', '#menu-toggle', function(e){
    $('#menu').toggle();
  });

  $(document).on('click', '#play-btn', function(e){
    player = document.getElementById('player')
    if (player.paused === false) {
      player.pause();
      $('#play-btn').html('<i class="fas fa-play"></i>');
    } else {
      player.play();
      $('#play-btn').html('<i class="fas fa-pause"></i>');
    }
  });

  var audio = $("audio");  
  audio[0].addEventListener('ended',function(){
    var currentTrackId = $('source').attr("data-track-id");
    var nextTrackId = $(".track[data-track-id='" + currentTrackId + "']").next().attr("data-track-id");
    if ( nextTrackId == null ) {
      return;
    } else {
      $(".track[data-track-id='" + currentTrackId + "']").removeClass('track-active'); // reset track highlight
      playTrack(nextTrackId);
    }
  });

});
</script>

</body>
</html>