<!DOCTYPE html>
<html>
  <head>
    <title>Play Your Music (for Google Drive)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="Play music from Google Drive.">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
<body>

<h1 style="display: none;">Play Your Music</h1>

<button id="authorize_button" style="display: none;">Sign In</button>
<button id="signout_button" style="display: none;">Sign Out</button>

<div id="data"></div>
<div id="count"></div>

<audio controls>
  <source src="">
  Your browser does not support the audio element.
</audio>

<script type="text/javascript">
var CLIENT_ID = '308625143299-1sc4kku4pd6k2n9qf70pqm0sqiarhiqp.apps.googleusercontent.com';
var API_KEY = 'AIzaSyDyZA3T_TLig3b4glBnzc8w-m94WRpP1z8';
var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
var SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly';

var authorizeButton = document.getElementById('authorize_button');
var signoutButton = document.getElementById('signout_button');

function handleClientLoad() {
  gapi.load('client:auth2', initClient);
}

function initClient() {
  gapi.client.init({
    apiKey: API_KEY,
    clientId: CLIENT_ID,
    discoveryDocs: DISCOVERY_DOCS,
    scope: SCOPES
  }).then(function () {
    gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
    authorizeButton.onclick = handleAuthClick;
    signoutButton.onclick = handleSignoutClick;
  }, function(error) {
    console.log(error);
  });
}

function updateSigninStatus(isSignedIn) {
  if (isSignedIn) {
    authorizeButton.style.display = 'none';
    signoutButton.style.display = 'block';
    findMusicFolder();
  } else {
    authorizeButton.style.display = 'block';
    signoutButton.style.display = 'none';
  }
}

function handleAuthClick(event) {
  gapi.auth2.getAuthInstance().signIn();
}

function handleSignoutClick(event) {
  gapi.auth2.getAuthInstance().signOut();
}

var APIcount = 0;

function APIcounter() {
  APIcount++;
  $('#count').html("<p>" + APIcount + "</p>");
}

function findMusicFolder() {
  gapi.client.drive.files.list({
    'pageSize': 1,
    'q' : " name contains 'music123' and trashed = false ",
    'fields': "nextPageToken, files(id, name)"
  }).then(function(response) {
    
    var files = response.result.files;
    if (files && files.length > 0) {
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        APIcounter();
        findAlbumFolders(file.id);
      }
    } else {
      alert('No music folder found.');
    }
  });
}

function findAlbumFolders(id) {
  var albumquery = "'" + id + "'" + " in parents and mimeType contains 'application/vnd.google-apps.folder' and trashed = false ";
  gapi.client.drive.files.list({
    'pageSize': 1000,
    'orderBy': 'name',
    'q' : albumquery,
    'fields': "nextPageToken, files(id, name)"
  }).then(function(response) {
    
    var albums = response.result.files;
    if (albums && albums.length > 0) {
      for (var i = 0; i < albums.length; i++) {
        var album = albums[i];
        APIcounter();
        console.log(album.name)
        //findAlbumFolders(file.id, file.name);

        var albumartquery = "'" + album.id + "'" + " in parents and mimeType contains 'image/' and name contains 'folder'";
        gapi.client.drive.files.list({
          'pageSize': 1,
          'q' : albumartquery,
          'fields': "nextPageToken, files(id, name)"
        }).then(function(response) {
          var arts = response.result.files;
          APIcounter();
          if (arts && arts.length > 0) {
            gapi.client.drive.files.get({
              'fileId': arts[0].id,
              'fields': "name, id, webContentLink"
            }).then(function(response) {
              artURL = response.result.webContentLink;
              APIcounter();
              console.log(album.id);
              $('#data').append("<a class='album' data-album-id='" + album.id + "'>" + "<img src='" + artURL + "' />" + "</a>");
            });
          } else {
            artURL = "blank.png";
            APIcounter();
            $('#data').append("<a class='album' data-album-id='" + album.id + "'>" + "<img src='" + artURL + "' />" + "</a>");
          }
        });


      }
    } else {
      alert('No album folders found.');
    }
  });
}

function listTracks(id) {
  //console.log("test1");
  var trackquery = "'" + id + "'" + " in parents and mimeType contains 'audio/'";
  gapi.client.drive.files.list({
    'pageSize': 50,
    'q' : trackquery,
    'fields': "nextPageToken, files(id, name)"
  }).then(function(response) {
    
    var files = response.result.files;
    if (files && files.length > 0) {
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        APIcounter();

        $('#data').append("<a class='track' data-track-id='" + file.id + "'>" + file.name + "</a>");
        
      }
    } else {
      alert('No files found.'); 
    }
  });
}

function playTrack(id) {
  gapi.client.drive.files.get({
    'fileId': id,
    'fields': "name, id, webContentLink"
  }).then(function(response) {
    
    //$('#data').append("<p>" + response.result.webContentLink + "</p>");
    APIcounter();

    var audio = $("audio");  
    $('source').attr("src", response.result.webContentLink);
    audio[0].pause();
    audio[0].load();//suspends and restores all audio element
    audio[0].oncanplaythrough = audio[0].play();
  });
}

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script async defer src="https://apis.google.com/js/api.js"
  onload="this.onload=function(){};handleClientLoad()"
  onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

<script type="text/javascript">
$( document ).ready(function() {

  $(document).on('click', '.track', function(){
    var trackId = $(this).attr("data-track-id");
    playTrack(trackId);
  });

  $(document).on('click', '.album', function(){
    //console.log("test");
    var albumId = $(this).attr("data-album-id");
    listTracks(albumId);
  });

});
</script>

</body>
</html>